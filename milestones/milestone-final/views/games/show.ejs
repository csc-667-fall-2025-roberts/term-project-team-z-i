<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= game.name %> - Uno Game</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <%
    // Helper function to convert card values to symbols
    function getCardSymbol(value) {
      const symbols = {
        'skip': '‚äò',
        'reverse': '‚áÑ',
        'draw2': '+2',
        'wild': 'üåà',
        'wild_draw4': 'üåà+4'
      };
      return symbols[value] || value;
    }
  %>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">üéÆ Uno Game</div>
        <div class="user-info">
          <a href="/lobby" class="btn btn-secondary">‚Üê Back to Lobby</a>
          <% if (user && !user.isGuest) { %>
            <span style="margin-left:0.75rem;">Welcome, <strong><%= user.username %></strong></span>
            <a href="/auth/logout" class="btn btn-danger" style="margin-left:0.5rem;">Logout</a>
          <% } else { %>
            <a href="/auth/login" class="btn btn-secondary" style="margin-left:0.5rem;">Login</a>
            <a href="/auth/signup" class="btn btn-primary" style="margin-left:0.5rem;">Sign Up</a>
          <% } %>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="game-board">
      <div class="game-board-header">
        <div>
          <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;"><%= game.name %></h1>
          <p style="color: #6b7280;">
            Status: <span class="game-status status-<%= game.state.replace('_', '-') %>">
              <%= game.state.replace('_', ' ') %>
            </span>
          </p>
        </div>
        <div>
          <p style="color: #6b7280;">
            Current Player: 
            <strong class="current-player-name">
              <% if (game.current_player.startsWith('AI_Player_')) { %>
                <span style="font-size: 1.1rem;">ü§ñ</span>
              <% } else if (game.current_player.startsWith('guest_')) { %>
                <span style="font-size: 1.1rem;">üë§</span>
              <% } %>
              <%= game.current_player %>
            </strong>
          </p>
          
          <!-- Debug info - COMMENTED OUT
          <div id="debugInfo" 
               data-game-state=""
               data-user-id=""
               data-creator-id=""
               data-is-creator=""
               style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-size: 12px; border-radius: 4px;">
            <strong>Debug Info:</strong><br>
            Game State: <br>
            User ID: <br>
            Creator ID: <br>
            Is Creator: <br>
            Condition Met: 
          </div>
          -->
          
          <% if (game.state === 'waiting' && user && user.id === game.created_by) { %>
            <button id="addAIBtn" class="btn btn-secondary" style="margin-top: 0.5rem; margin-right: 0.5rem;">
              ‚ûï Add AI Player
            </button>
            <button id="startGameBtn" class="btn btn-success" style="margin-top: 0.5rem; margin-right: 0.5rem;">
              Start Game
            </button>
            <button id="deleteGameBtn" class="btn" style="margin-top: 0.5rem; background-color: #dc2626; color: white;">
              üóëÔ∏è Delete Game
            </button>
          <% } else if (game.state === 'waiting') { %>
            <p style="color: #999; font-size: 0.875rem;">
              (Waiting for game creator to start the game)
            </p>
          <% } %>
          
          <!-- Leave Game Button - available to all players except creator in waiting state -->
          <% if (user && !(game.state === 'waiting' && user.id === game.created_by)) { %>
            <form action="/games/<%= game.id %>/leave" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to leave this game?');">
              <button type="submit" class="btn" style="margin-top: 0.5rem; background-color: #f59e0b; color: white;">
                üö™ Leave Game
              </button>
            </form>
          <% } %>
        </div>
      </div>

      <% if (game.state === 'active' && game.gameState) { %>
        <!-- Compact 3-Column Layout -->
        <div style="display: grid; grid-template-columns: 180px 1fr 180px; gap: 1rem; margin: 1rem 0;">
          
          <!-- Left: Players List -->
          <div>
            <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600;">üë• Players</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <% game.players.forEach((player) => { %>
                <div class="player-card <%= player.username === game.current_player ? 'active' : '' %>" 
                     data-player-id="<%= player.id %>"
                     style="padding: 0.5rem; margin: 0;">
                  <div class="player-name" style="font-size: 0.8rem;">
                    <% if (player.username.startsWith('AI_Player_')) { %>
                      <span>ü§ñ</span>
                    <% } else if (player.username.startsWith('guest_')) { %>
                      <span>üë§</span>
                    <% } %>
                    <%= player.username %>
                  </div>
                  <div class="player-cards" style="font-size: 0.7rem;"><%= player.cardCount %> cards</div>
                </div>
              <% }); %>
            </div>
          </div>

          <!-- Center: Game Board -->
          <div>
            <!-- Timer -->
            <div id="turnTimerDisplay" style="margin-bottom: 0.75rem; display: none;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.6rem 1rem; border-radius: 8px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                  <span style="font-size: 1.1rem;">‚è±Ô∏è</span>
                  <span style="font-size: 0.95rem; font-weight: 700;">Time: <span id="turnTimerSeconds">10</span>s</span>
                </div>
                <div style="background: rgba(255,255,255,0.25); height: 5px; border-radius: 3px; overflow: hidden;">
                  <div id="turnTimerBar" style="height: 100%; background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444); width: 100%; transition: width 0.1s linear;"></div>
                </div>
              </div>
            </div>

            <!-- Discard & Draw -->
            <div class="game-center" style="margin-bottom: 0.75rem;">
              <div class="discard-pile">
                <% if (game.gameState.discard_pile && game.gameState.discard_pile.length > 0) { %>
                  <% const topCard = game.gameState.discard_pile[game.gameState.discard_pile.length - 1]; %>
                  <div class="uno-card card-<%= topCard.color %>" style="width:90px; height:126px;">
                    <div class="uno-value" style="font-size:1.3rem;"><%= getCardSymbol(topCard.value) %></div>
                  </div>
                <% } else { %>
                  <div style="text-align: center;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">üÉè</div>
                    <div style="font-size: 0.7rem;">DISCARD</div>
                  </div>
                <% } %>
              </div>
              <div class="draw-pile" id="drawCardBtn">
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">üé¥</div>
                  <div style="font-size: 0.7rem;">DRAW</div>
                </div>
              </div>
            </div>

            <!-- Your Hand -->
            <div class="player-hand" style="margin: 0;">
              <h3 class="hand-title" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Your Hand (<span id="cardCount"><%= hand.length %></span> cards)</h3>
              <div class="hand-cards" style="justify-content: center; gap: 0.5rem;">
                <% if (hand && hand.length > 0) { %>
                  <% hand.forEach(function(card, index){ %>
                    <div class="uno-card card-<%= card.color %>" data-card-index="<%= index %>" style="width: 65px; height: 91px;">
                      <div class="uno-value" style="font-size: 1.1rem;"><%= getCardSymbol(card.value) %></div>
                    </div>
                  <% }); %>
                <% } else { %>
                  <p style="color:#6b7280; font-size: 0.85rem;">No cards</p>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Right: Game Info -->
          <div>
            <div style="background: #f9fafb; padding: 0.75rem; border-radius: 8px; border: 1px solid #e5e7eb;">
              <h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; color: #1f2937; font-weight: 600;">üìã Info</h3>
              <div style="font-size: 0.75rem; color: #4b5563; line-height: 1.6;">
                <div style="margin-bottom: 0.5rem;">
                  <strong>Current:</strong><br>
                  <% if (game.current_player.startsWith('AI_Player_')) { %>
                    ü§ñ
                  <% } else if (game.current_player.startsWith('guest_')) { %>
                    üë§
                  <% } %>
                  <%= game.current_player %>
                </div>
                <div style="margin-bottom: 0.5rem;">
                  <strong>Direction:</strong><br>
                  <% if (game.direction === 'clockwise') { %>
                    üîÑ Clockwise
                  <% } else { %>
                    ‚Ü©Ô∏è Counter-CW
                  <% } %>
                </div>
                <div>
                  <strong>Players:</strong> <%= game.players.length %>
                </div>
              </div>
            </div>
          </div>

        </div>
      <% } else if (game.state === 'waiting') { %>
        <div style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 0.75rem; margin: 2rem 0;">
          <h3 style="color: #1f2937; margin-bottom: 1rem;">‚è≥ Waiting for game to start...</h3>
          <p style="color: #6b7280;">
            <%= game.players.length %> / <%= game.max_players || 4 %> players joined
          </p>
          <% if (user && user.id === game.created_by) { %>
            <p style="color: #667eea; margin-top: 1rem; font-weight: 500;">
              You can start the game when ready!
            </p>
          <% } %>
        </div>
      <% } else if (game.state === 'finished') { %>
        <div style="text-align: center; padding: 3rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 0.75rem; margin: 2rem 0;">
          <h3 style="color: #1f2937; margin-bottom: 1rem;">üéâ Game Over!</h3>
          <p style="color: #6b7280;">
            Thanks for playing!
          </p>
          <a href="/lobby" class="btn btn-primary" style="margin-top: 1.5rem;">Return to Lobby</a>
        </div>
      <% } %>
    </div>

    <div class="chat-area">
      <h3 class="card-header">üí¨ Game Chat</h3>
      <div class="chat-messages" id="chatMessages">
        <% if (messages && messages.length > 0) { %>
          <% messages.forEach(function(msg) { %>
            <div class="chat-message">
              <strong>
                <% if (msg.username.startsWith('AI_Player_')) { %>
                  ü§ñ 
                <% } else if (msg.username.startsWith('guest_')) { %>
                  üë§ 
                <% } %>
                <%= msg.username %>
              </strong>
              <span style="color:#6b7280; font-size:0.85rem; margin-left:0.5rem;"><%= msg.created_at %></span>
              <div><%= msg.message %></div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="chat-message system-message">
            <strong style="color: #667eea;">System</strong>
            <div>Welcome to the game! Good luck! üéÆ</div>
          </div>
        <% } %>
      </div>

      <% if (user) { %>
        <form id="chatForm" class="chat-input-group">
          <input 
            type="text" 
            id="chatInput"
            class="chat-input" 
            placeholder="Type a message..."
            maxlength="500"
          >
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      <% } %>
    </div>
  </div>

  <!-- Wild Card Color Selection Modal -->
  <div id="colorPickerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px;">
      <h3 style="margin-bottom: 1.5rem; color: #333;">Choose a Color</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <button class="color-choice-btn" data-color="red" style="padding: 1.5rem; font-size: 1.2rem; border: 3px solid #ef4444; background: #fee2e2; color: #991b1b; border-radius: 8px; cursor: pointer; font-weight: bold;">
          üî¥ Red
        </button>
        <button class="color-choice-btn" data-color="blue" style="padding: 1.5rem; font-size: 1.2rem; border: 3px solid #3b82f6; background: #dbeafe; color: #1e3a8a; border-radius: 8px; cursor: pointer; font-weight: bold;">
          üîµ Blue
        </button>
        <button class="color-choice-btn" data-color="green" style="padding: 1.5rem; font-size: 1.2rem; border: 3px solid #10b981; background: #d1fae5; color: #065f46; border-radius: 8px; cursor: pointer; font-weight: bold;">
          üü¢ Green
        </button>
        <button class="color-choice-btn" data-color="yellow" style="padding: 1.5rem; font-size: 1.2rem; border: 3px solid #f59e0b; background: #fef3c7; color: #92400e; border-radius: 8px; cursor: pointer; font-weight: bold;">
          üü° Yellow
        </button>
      </div>
    </div>
  </div>

  <!-- Game data for JavaScript -->
  <div id="gameData" 
       data-game-id="<%= game.id %>" 
       data-user-id="<%= user.id %>" 
       data-game-state="<%= game.state %>"
       data-current-player-id="<%= game.current_player_id || '' %>"
       data-hand='<%- JSON.stringify(hand) %>' 
       style="display:none;">
  </div>

  <script src="/js/game.js"></script>
  <script>
    console.log('=== INLINE SCRIPT STARTED ===');
    
    // Debug info
    var debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
      console.log('=== GAME DEBUG INFO ===');
      console.log('Game State:', debugInfo.getAttribute('data-game-state'));
      console.log('User ID:', debugInfo.getAttribute('data-user-id'));
      console.log('Creator ID:', debugInfo.getAttribute('data-creator-id'));
      console.log('Is Creator?:', debugInfo.getAttribute('data-is-creator'));
      console.log('=====================');
    }
    
    // Initialize game from data attributes
    var gameData = document.getElementById('gameData');
    console.log('Game data element:', gameData);
    
    if (!gameData) {
      console.error('ERROR: Game data element not found!');
    } else {
      // Assign to global variables declared in game.js (don't redeclare with var/let)
      gameId = parseInt(gameData.getAttribute('data-game-id'));
      userId = parseInt(gameData.getAttribute('data-user-id'));
      currentHand = JSON.parse(gameData.getAttribute('data-hand'));
      
      console.log('Parsed game data:', { gameId, userId, handSize: currentHand.length });
      
      // Initialize the game client
      if (typeof initGame === 'function') {
        initGame(gameId, userId, currentHand);
        console.log('initGame called successfully');
      } else {
        console.error('ERROR: initGame function not found!');
      }
      
      console.log('Game page loaded', { gameId: gameId, userId: userId, handSize: currentHand.length });
      
      // Check if socket is available
      if (typeof socket === 'undefined') {
        console.error('ERROR: socket is not defined!');
      } else {
        console.log('Socket is available:', socket);
      }
      
      // Start Game button handler
      var startGameBtn = document.getElementById('startGameBtn');
      console.log('Start Game Button found:', startGameBtn);
      
      if (startGameBtn) {
        console.log('Attaching click handler to Start Game button');
        startGameBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('=== START GAME BUTTON CLICKED ===');
          
          if (!gameId) {
            console.error('No gameId available');
            alert('Error: No game ID');
            return;
          }
          
          if (typeof socket === 'undefined') {
            console.error('Socket not available');
            alert('Error: Socket connection not available');
            return;
          }
          
          console.log('Emitting start_game event for gameId:', gameId);
          socket.emit('start_game', { gameId: gameId });
          startGameBtn.disabled = true;
          startGameBtn.textContent = 'Starting...';
        });
        console.log('Start Game button handler attached');
      } else {
        console.log('Start Game button not found in DOM');
      }
      
      // Add AI Player button handler
      var addAIBtn = document.getElementById('addAIBtn');
      console.log('Add AI Button found:', addAIBtn);
      
      if (addAIBtn) {
        console.log('Attaching click handler to Add AI button');
        addAIBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          console.log('=== ADD AI BUTTON CLICKED ===');
          
          try {
            addAIBtn.disabled = true;
            addAIBtn.textContent = 'Adding AI...';
            
            console.log('Sending POST request to /games/' + gameId + '/add-ai');
            
            var response = await fetch('/games/' + gameId + '/add-ai', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            console.log('Response status:', response.status);
            
            var data = await response.json();
            console.log('Response data:', data);
            
            if (response.ok) {
              console.log('AI Player added successfully!');
              alert('AI Player added! Reloading...');
              // Reload to show the new player
              setTimeout(function() {
                window.location.reload();
              }, 500);
            } else {
              var errorMsg = data.error || 'Failed to add AI player';
              console.error('Error:', errorMsg);
              alert('Error: ' + errorMsg);
              addAIBtn.disabled = false;
              addAIBtn.textContent = '‚ûï Add AI Player';
            }
          } catch (error) {
            console.error('Error adding AI player:', error);
            alert('Error adding AI player: ' + error.message);
            addAIBtn.disabled = false;
            addAIBtn.textContent = '‚ûï Add AI Player';
          }
        });
        console.log('Add AI button handler attached');
      } else {
        console.log('Add AI button not found - check if user is game creator and game is in waiting state');
      }
      
      // Delete Game button handler
      var deleteGameBtn = document.getElementById('deleteGameBtn');
      console.log('Delete Game Button found:', deleteGameBtn);
      
      if (deleteGameBtn) {
        console.log('Attaching click handler to Delete Game button');
        deleteGameBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          console.log('=== DELETE GAME BUTTON CLICKED ===');
          
          if (!confirm('Are you sure you want to delete this game? This cannot be undone!')) {
            return;
          }
          
          if (!gameId) {
            console.error('No gameId available');
            alert('Error: No game ID');
            return;
          }
          
          deleteGameBtn.disabled = true;
          deleteGameBtn.textContent = 'Deleting...';
          
          try {
            console.log('Sending DELETE request for gameId:', gameId);
            var response = await fetch('/games/' + gameId, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            console.log('Delete response status:', response.status);
            var data = await response.json();
            console.log('Delete response data:', data);
            
            if (data.success) {
              console.log('Game deleted successfully!');
              alert('Game deleted successfully!');
              window.location.href = '/lobby';
            } else {
              var errorMsg = data.error || 'Failed to delete game';
              console.error('Error:', errorMsg);
              alert('Error: ' + errorMsg);
              deleteGameBtn.disabled = false;
              deleteGameBtn.textContent = 'üóëÔ∏è Delete Game';
            }
          } catch (error) {
            console.error('Error deleting game:', error);
            alert('Error deleting game: ' + error.message);
            deleteGameBtn.disabled = false;
            deleteGameBtn.textContent = 'üóëÔ∏è Delete Game';
          }
        });
        console.log('Delete Game button handler attached');
      }
    }
    
    console.log('=== INLINE SCRIPT COMPLETED ===');
  </script>
</body>
</html>
